FROM ubuntu:20.04

RUN apt-get update
RUN apt-get upgrade --yes
RUN DEBIAN_FRONTEND=noninteractive TZ=Etc/UTC apt-get install cmake python3 python3-pip git make curl --yes


# Installing OCaml
#   - opam v2.0.5
#   - OCaml v5.0.0
#   - dune v3.10.0
#   - menhir v20230608

RUN apt-get install opam --yes
RUN opam init --disable-sandboxing
RUN opam switch create 5.0.0
RUN opam install dune menhir --yes
RUN eval $(opam config env)


# Install wabt

WORKDIR /home
RUN git clone --recursive https://github.com/WebAssembly/wabt
WORKDIR /home/wabt
RUN git submodule update --init
RUN mkdir wabt/build && cd wabt/build && cmake .. && cmake --build .
ENV PATH="$PATH:/home/wabt/bin"


# Install wasmer

RUN curl https://get.wasmer.io -sSfL | sh
ENV WASMER_DIR="/root/.wasmer"
ENV WASMER_CACHE_DIR="$WASMER_DIR/cache"
ENV PATH="$PATH:$WASMER_DIR/bin"


# Install wasmtime

RUN curl https://wasmtime.dev/install.sh -sSf | bash


# Install spectec

WORKDIR /home
RUN git clone https://github.com/kaist-plrg/spectec.git
WORKDIR /home/spectec/spectec
RUN git checkout lww


# Install wasmedge

WORKDIR /home/spectec/spectec/runtimes/wasmedge
RUN curl -sSf https://raw.githubusercontent.com/WasmEdge/WasmEdge/master/utils/install.sh | bash -s -- -p .
RUN /bin/bash -c "source ./env && make"
ENV PATH="$PATH:/home/spectec/spectec/runtimes/wasmedge"


WORKDIR /home/spectec/spectec


# Automate `eval $(opam env)`

ENTRYPOINT ["opam", "exec", "--"]
CMD ["/bin/bash", "--login"]
